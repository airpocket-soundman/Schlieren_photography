# Movie Recorder - 動画記録プロジェクト

SPRESENSEカメラからの映像をmicroSDカードに動画ファイルとして記録するプロジェクトです。

## 概要

このプロジェクトは、SPRESENSEのHDRカメラから取得した映像を液晶ディスプレイにリアルタイムでストリーミング表示しながら、連続した画像フレームをmicroSDカードに保存する動画記録アプリケーションです。display_streamingプロジェクトをベースに、静止画の連続撮影による動画記録機能を追加する予定です。

## 主な機能（計画中）

- **ライブビュー**: QVGA（320x240）解像度でのリアルタイム映像表示
- **動画記録**: 連続フレーム撮影によるムービー記録
- **microSD保存**: 撮影したフレームを順次SDカードに保存
- **録画制御**: シリアルコマンドまたはボタンによる録画開始/停止
- **フレームレート制御**: 設定可能なフレームレート
- **HDR撮影**: HDR自動モードによる明暗差の大きいシーンでの最適化
- **高速描画**: LovyanGFXによる最適化された画像転送

## ハードウェア構成

### 必要な機器

- **SPRESENSE メインボード**
- **SPRESENSE 拡張ボード**
- **SPRESENSE HDRカメラボード**
- **ILI9341ドライバ搭載 TFT液晶**（240x320ピクセル、SPI接続）
- **microSDカード**（動画保存用、Class 10以上推奨、容量：16GB以上推奨）

### ピン配置

#### カメラ接続
カメラボードはSPRESENSEメインボードに直接接続します。

#### ディスプレイ接続（SPI4使用）

| 機能 | SPRESENSEピン | 説明 |
|------|--------------|------|
| **SCLK** | D13 (SPI4) | SPIクロック |
| **MOSI** | D11 (SPI4) | SPIデータ出力 |
| **MISO** | D12 (SPI4) | SPIデータ入力 |
| **DC** | D9 | データ/コマンド選択 |
| **CS** | D10 | チップセレクト |
| **RESET** | D8 | リセット |
| **VCC** | 3.3V | 電源 |
| **GND** | GND | グランド |

#### SDカード
拡張ボードのmicroSDカードスロットを使用します。

**重要**: 
- SPRESENSEのSPI4ポートを使用しています
- カメラとディスプレイを同時に使用するため、電源容量に注意してください
- **外部電源の使用を強く推奨します**（5V 2A以上）
- 動画記録は大量のデータ書き込みを行うため、高速SDカード（Class 10以上）が必要です

## 開発環境

### 必要なソフトウェア

- [PlatformIO](https://platformio.org/)
- Visual Studio Code + PlatformIO IDE拡張機能

### 使用ライブラリ

- **LovyanGFX** (v1.1.16以降): 高速グラフィックスライブラリ
- **Camera**: SPRESENSE標準カメラライブラリ（プラットフォームに含まれる）
- **SDHCI**: SPRESENSE標準SDカードライブラリ（プラットフォームに含まれる）

## セットアップ手順

### 1. ハードウェア接続

1. HDRカメラボードをSPRESENSEメインボードに接続
2. 上記のピン配置表に従って、TFT液晶を拡張ボードに接続
3. microSDカード（Class 10以上、16GB以上推奨）を拡張ボードのスロットに挿入
4. **外部電源を接続**（必須：5V 2A以上）

### 2. プロジェクトのビルドとアップロード

#### Visual Studio Codeでの操作

**重要**: このリポジトリには複数のPlatformIOプロジェクトが含まれています。**movie_recorderフォルダを直接開いてください**。

1. VS Codeで**movie_recorderフォルダ**を開きます
   - `ファイル` → `フォルダーを開く` → `movie_recorder`フォルダを選択
   - または、コマンドラインから: `code movie_recorder`

2. PlatformIOタブを開きます

3. ビルド:
   - PlatformIOツールバーの「Build」ボタン
   - または `Ctrl+Alt+B`

4. SPRESENSEを接続してアップロード:
   - PlatformIOツールバーの「Upload」ボタン
   - または `Ctrl+Alt+U`

5. シリアルモニタを開いて動作確認:
   - `Ctrl+Alt+S` または PlatformIOツールバーの「Serial Monitor」

#### コマンドラインでの操作

```bash
# movie_recorderディレクトリに移動
cd movie_recorder

# ビルド
pio run

# SPRESENSEにアップロード
pio run --target upload

# シリアルモニタを開く
pio device monitor
```

## 使用方法

### 起動（現在はdisplay_streamingと同じ動作）

1. SPRESENSEに電源を供給すると自動的に起動します

2. シリアルモニタに初期化メッセージが表示されます

3. TFT液晶にカメラからのリアルタイム映像（ライブビュー）が表示されます

### 録画方法（実装予定）

動画記録機能は今後実装予定です。以下のような機能を計画しています：

1. シリアルモニタから録画開始コマンドを送信
2. 連続フレーム撮影開始
3. 各フレームをJPEGまたはRAW形式でSDカードに保存
4. 録画停止コマンドで記録終了
5. 保存されたフレームから動画ファイルを生成（PC側で後処理）

## プロジェクト構成

```
movie_recorder/
├── platformio.ini                    # PlatformIO設定ファイル
├── README.md                         # 本ファイル
├── .gitignore                        # Git除外設定
├── include/                          # ヘッダファイル用ディレクトリ
├── lib/                              # 追加ライブラリ用ディレクトリ
└── src/
    ├── main.cpp                      # メインプログラム
    └── LGFX_SPRESENSE_ILI9341.hpp   # LovyanGFX設定ファイル
```

### 主要関数（現在）

- **`setupDisplay()`**: ディスプレイの初期化
- **`setupCamera()`**: カメラの初期化とストリーミング開始
- **`setupSD()`**: SDカードの初期化
- **`CamCB()`**: カメラコールバック（ライブビュー用）
- **`takePictureAndSave()`**: JPEG撮影と保存（静止画モード）
- **`setup()`**: 初期化処理
- **`loop()`**: メインループ

## トラブルシューティング

### カメラが初期化できない

**症状**: "カメラの初期化に失敗しました" というエラーメッセージ

**対処法**:
- カメラボードがメインボードにしっかり接続されているか確認
- カメラモジュールのケーブル接続を確認
- 電源供給が十分か確認（外部電源使用を推奨）

### SDカードエラー

**症状**: "SDカードの初期化に失敗しました"

**対処法**:
- SDカードが正しく挿入されているか確認
- SDカードがフォーマットされているか確認（FAT32推奨）
- Class 10以上の高速SDカードを使用
- 別のSDカードで試す

### 電源の問題

**症状**: 動作が不安定、リセットがかかる、書き込みエラー

**対処法**:
- **必ず外部電源を使用**（5V 2A以上）
- USB給電では電力不足により正常動作しません
- 動画記録は高負荷処理のため、安定した電源が必須

## 今後の開発計画

### Phase 1: 連続撮影機能
- [ ] 連続フレーム撮影の実装
- [ ] フレームレート制御
- [ ] バッファリング機能

### Phase 2: 動画記録機能
- [ ] 録画開始/停止コマンド
- [ ] フレーム番号管理
- [ ] ファイル名のタイムスタンプ化

### Phase 3: 最適化
- [ ] 書き込み速度の最適化
- [ ] メモリ使用量の最適化
- [ ] フレームドロップ検出

### Phase 4: シュリーレン撮影対応
- [ ] 高速連続撮影モード
- [ ] トリガー撮影機能
- [ ] 密度変化解析との連携

## 技術仕様（目標）

### 動画記録
- **解像度**: VGA (640x480) または QVGA (320x240)
- **フレームレート**: 5-15 FPS（SDカード書き込み速度に依存）
- **記録形式**: 連続JPEG画像（Motion JPEGと互換）
- **ファイル形式**: 個別JPEGファイルまたはMotion JPEG (AVI)

### パフォーマンス見積もり
- JPEG圧縮: カメラハードウェアエンコーダ使用
- 1フレームあたりのファイルサイズ: 約10-30KB
- 書き込み速度: Class 10 SDカードで約10MB/s
- 推定フレームレート: 10-15 FPS（VGA JPEG時）

### メモリ使用量
- ライブビューバッファ: 約150KB
- 録画バッファ: 約100-200KB
- 合計: 約300-400KB

## 制限事項

1. **電源要件**: 外部電源（5V 2A以上）が必須
2. **SDカード**: Class 10以上の高速カード必須
3. **記録時間**: SDカード容量とフレームサイズに依存
4. **フレームレート**: 書き込み速度により制限される
5. **同時処理**: 録画中は他の処理が制限される可能性あり

## 参考資料

- [LovyanGFX GitHub](https://github.com/lovyan03/LovyanGFX)
- [SPRESENSE Camera API](https://developer.sony.com/develop/spresense/docs/arduino_developer_guide_ja.html#_camera)
- [SPRESENSE公式ドキュメント](https://developer.sony.com/develop/spresense/)
- [Motion JPEG仕様](https://en.wikipedia.org/wiki/Motion_JPEG)

## ライセンス

TBD

---

**更新日**: 2025/12/03  
**プロジェクト状況**: 開発準備中 - display_streamingコードをベースにセットアップ完了。動画記録機能は今後実装予定。

# 📘 README — デジタルシュリーレン(BOS)用ランダムドット背景設計

## 概要

本書は **デジタルシュリーレン法（BOS: Background Oriented Schlieren）** に使用する  
**ランダムドット背景の設計仕様**をまとめたものです。

対象システムは：

- **カメラ解像度：1280 × 720 px**
- **実視野：128 mm × 72 mm**
- **解像度換算：10 px/mm（1px = 約 0.1mm）**

BOS は背景パターンの局所的な“位置ずれ（変位ベクトル）”を解析するため、  
背景設計は画像処理精度に直結する重要要素です。

---

## 1. パターン設計の基本方針

BOS背景は以下の条件を満たす必要があります：

### ✔ ランダム性  
周期構造（市松模様・格子・QRコードなど）は避け、  
**完全ランダムに散らばったドット**を採用します。

### ✔ 高コントラスト  
白背景に黒ドット（または逆）の二値構造が最適です。  
Spresense は GRAY で処理するため色は不要です。

### ✔ 均一な特徴分布  
画面全体に均一に「特徴」があることで、  
全ピクセルで安定した相関（ブロックマッチング）が可能になります。

---

## 2. 解像度とドット物理サイズの関係

与えられた実視野とピクセル解像度から：

| 指標 | 計算結果 |
|------|----------|
| 水平解像度 | 1280 px / 128 mm = **10 px/mm** |
| 垂直解像度 | 720 px / 72 mm = **10 px/mm** |
| 1 px の物理サイズ | 約 **0.1 mm** |

### ▶ 推奨ドット径  
**直径 2〜4 px（0.2〜0.4 mm）**

理由：
- 小さすぎると撮像時のノイズに埋もれる  
- 大きすぎるとサブピクセル変位が表現できない  
- BOS の一般的最適範囲が 2〜4 px

---

## 3. ドット密度（coverage）

推奨値は **10〜20%**。

- 密度が低い → 相関が取りづらい  
- 密度が高い → 面が黒く潰れて情報量が減る  

**15%前後**が扱いやすく最も安定します。

---

## 4. 推奨パラメータまとめ

| 項目 | 推奨値 |
|------|--------|
| 背景サイズ（カメラ画像） | 1280×720 px |
| 実視野 | 128×72 mm |
| 解像度換算 | 10 px/mm |
| ドット直径 | 2〜4 px（0.2〜0.4 mm） |
| ドット密度 | 10〜20%（推奨15%） |
| パターン色 | 白地＋黒ドット（単色） |
| パターン生成法 | 完全ランダム（乱数） |
| 印刷の場合 | 高品質マット紙 or 光沢紙推奨 |
| ディスプレイ表示 | 明るく均一なバックライトを推奨 |

---

## 5. パターン生成用 Python スクリプト

以下は **1280×720 用 BOS 背景画像**を生成する Python コードです。

```python
import numpy as np
import cv2

# Camera resolution
W = 1280
H = 720

# Dot parameters
dot_coverage = 0.15   # 15% coverage
dot_radius_px = 2     # radius => diameter ~4px (0.4mm)

# White background
img = np.ones((H, W), dtype=np.uint8) * 255

# Number of dots (approx.)
pixel_area_per_dot = np.pi * dot_radius_px * dot_radius_px
N = int((W * H * dot_coverage) / pixel_area_per_dot)

ys = np.random.randint(dot_radius_px, H - dot_radius_px, N)
xs = np.random.randint(dot_radius_px, W - dot_radius_px, N)

for x, y in zip(xs, ys):
    cv2.circle(img, (x, y), dot_radius_px, 0, -1)

cv2.imwrite("bos_random_dots_1280x720.png", img)
print("Saved: bos_random_dots_1280x720.png")
```

---

## 6. 使用上の注意

### ● 光源は均一に  
背景全体が均一に照明されている必要があります。  
影・ホットスポット・反射は解析誤差を大きくします。

### ● カメラのピント  
背景に正確にピント合わせをする必要はありません。  
むしろ「少しぼかし気味」が相関精度を高めます。

### ● 基準画像の重要性  
背景のみの **基準フレーム（ref）** を必ず 1 枚撮影し、  
以降の解析の基準として使用します。

---

## 7. 今後の拡張

必要に応じて以下を追加できます：

- **ブルーノイズパターン**（ランダムより高い相関精度）
- **サブピクセル補間**による高精度BOS
- **光流（optical flow）解析**による連続場解析
- **背景の大サイズ化（A3, A2）**への拡張

---

## ライセンス

本設計仕様は自由に使用・改変いただけます。  
研究・製作・教育用途を想定しています。

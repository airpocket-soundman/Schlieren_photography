# Display Streaming - カメラライブビュー＆JPEG撮影プロジェクト

SPRESENSE HDRカメラの映像をILI9341 TFT液晶にリアルタイム表示し、シリアル入力でHD画質のJPEG写真を撮影・保存するプロジェクトです。

## 概要

このプロジェクトは、SPRESENSEのカメラから取得した映像を液晶ディスプレイにリアルタイムでストリーミング表示しながら、任意のタイミングでHD画質（1280x720）のJPEG画像をSDカードに保存できる実用的なカメラアプリケーションです。camera_testとdisplay_testの機能を統合し、さらに機能を拡張しています。

## 主な機能

- **ライブビュー**: QVGA（320x240）解像度でのリアルタイム映像表示
- **JPEG撮影**: HD（1280x720）解像度での高画質撮影
- **HDR撮影**: HDR自動モードによる明暗差の大きいシーンでの最適化
- **SDカード保存**: 撮影したJPEG画像を自動的にファイル名を付けて保存
- **シリアルトリガー**: シリアルモニタから任意の文字を送信して撮影
- **高速描画**: LovyanGFXによる最適化された画像転送
- **自動設定**: 自動露出・自動ホワイトバランス

## ハードウェア構成

### 必要な機器

- **SPRESENSE メインボード**
- **SPRESENSE 拡張ボード**
- **SPRESENSE HDRカメラボード**
- **ILI9341ドライバ搭載 TFT液晶**（240x320ピクセル、SPI接続）
- **microSDカード**（撮影画像の保存用、Class 10推奨）

### ピン配置

#### カメラ接続
カメラボードはSPRESENSEメインボードに直接接続します。

#### ディスプレイ接続（SPI4使用）

| 機能 | SPRESENSEピン | 説明 |
|------|--------------|------|
| **SCLK** | D13 (SPI4) | SPIクロック |
| **MOSI** | D11 (SPI4) | SPIデータ出力 |
| **MISO** | D12 (SPI4) | SPIデータ入力 |
| **DC** | D9 | データ/コマンド選択 |
| **CS** | D10 | チップセレクト |
| **RESET** | D8 | リセット |
| **VCC** | 3.3V | 電源 |
| **GND** | GND | グランド |

#### SDカード
拡張ボードのmicroSDカードスロットを使用します。

**重要**: 
- SPRESENSEのSPI4ポートを使用しています
- カメラとディスプレイを同時に使用するため、電源容量に注意してください
- USB給電では電力不足の可能性があるため、外部電源の使用を推奨します

## 開発環境

### 必要なソフトウェア

- [PlatformIO](https://platformio.org/)
- Visual Studio Code + PlatformIO IDE拡張機能

### 使用ライブラリ

- **LovyanGFX** (v1.1.16以降): 高速グラフィックスライブラリ
- **Camera**: SPRESENSE標準カメラライブラリ（プラットフォームに含まれる）
- **SDHCI**: SPRESENSE標準SDカードライブラリ（プラットフォームに含まれる）

## セットアップ手順

### 1. ハードウェア接続

1. HDRカメラボードをSPRESENSEメインボードに接続
2. 上記のピン配置表に従って、TFT液晶を拡張ボードに接続
3. microSDカードを拡張ボードのスロットに挿入
4. **外部電源を接続**（推奨：5V 2A以上）

### 2. プロジェクトのビルドとアップロード

#### Visual Studio Codeでの操作

**重要**: このリポジトリには複数のPlatformIOプロジェクトが含まれています。**display_streamingフォルダを直接開いてください**。

1. VS Codeで**display_streamingフォルダ**を開きます
   - `ファイル` → `フォルダーを開く` → `display_streaming`フォルダを選択
   - または、コマンドラインから: `code display_streaming`

2. PlatformIOタブを開きます

3. ビルド:
   - PlatformIOツールバーの「Build」ボタン
   - または `Ctrl+Alt+B`

4. SPRESENSEを接続してアップロード:
   - PlatformIOツールバーの「Upload」ボタン
   - または `Ctrl+Alt+U`

5. シリアルモニタを開いて動作確認:
   - `Ctrl+Alt+S` または PlatformIOツールバーの「Serial Monitor」

#### コマンドラインでの操作

```bash
# display_streamingディレクトリに移動
cd display_streaming

# ビルド
pio run

# SPRESENSEにアップロード
pio run --target upload

# シリアルモニタを開く
pio device monitor
```

## 使用方法

### 起動

1. SPRESENSEに電源を供給すると自動的に起動します

2. シリアルモニタに以下のメッセージが表示されます：
   ```
   ===================================
     Camera + Display Test
     撮影→SD保存→表示
   ===================================
   
   ディスプレイを初期化しています...
   ディスプレイの初期化が完了しました
   SDカードを初期化しています...
   SDカードの初期化が完了しました
   カメラを初期化しています...
   カメラの初期化が完了しました
   ストリーミング開始...
   ストリーミング開始しました
   HDRモード: 有効
   静止画フォーマット: HD JPEG (1280x720) HDR
   
   準備完了!
   シリアルモニタに任意の文字を送信すると撮影します
   -----------------------------------
   ```

3. TFT液晶にカメラからのリアルタイム映像（ライブビュー）が表示されます

### 撮影方法

1. シリアルモニタに**任意の文字**（例：`a`、`Enter`キー等）を送信します

2. 以下の処理が自動的に実行されます：
   - ライブビューが一時停止
   - HD画質（1280x720）でJPEG撮影
   - SDカードに保存（ファイル名：PICT000.JPG, PICT001.JPG...）
   - ライブビューが再開

3. シリアルモニタに保存結果が表示されます：
   ```
   ストリーミング停止中...
   JPEG撮影中...
   JPEG保存中: PICT000.JPG
   JPEG保存完了: PICT000.JPG (45678 bytes)
   ストリーミング再開中...
   表示モードに戻りました
   撮影回数: 1
   -----------------------------------
   次の撮影待機中...
   ```

### 保存された画像

- **保存場所**: SDカードのルートディレクトリ
- **ファイル名**: PICT000.JPG, PICT001.JPG, PICT002.JPG...（連番）
- **解像度**: 1280x720ピクセル（HD）
- **形式**: JPEG
- **HDR**: 自動モード有効

## パフォーマンス

### ライブビュー
- **解像度**: QVGA (320x240ピクセル)
- **フレームレート**: 約10-15 FPS（環境により変動）
- **遅延**: 約100-200ms
- **画質**: YUV422からRGB565への変換

### 静止画撮影
- **解像度**: HD (1280x720ピクセル)
- **形式**: JPEG（カメラハードウェアエンコード）
- **HDR**: 自動モード
- **撮影時間**: 約1-2秒
- **ファイルサイズ**: 約30-100KB（シーンにより変動）

## プロジェクト構成

```
display_streaming/
├── platformio.ini                    # PlatformIO設定ファイル
├── README.md                         # 本ファイル
├── include/                          # ヘッダファイル用ディレクトリ
├── lib/                              # 追加ライブラリ用ディレクトリ
└── src/
    ├── main.cpp                      # メインプログラム
    └── LGFX_SPRESENSE_ILI9341.hpp   # LovyanGFX設定ファイル
```

### main.cppの主要関数

- **`setupDisplay()`**: ディスプレイの初期化
- **`setupCamera()`**: カメラの初期化とストリーミング開始
- **`setupSD()`**: SDカードの初期化
- **`CamCB()`**: カメラコールバック（ライブビュー用）
- **`takePictureAndSave()`**: JPEG撮影と保存
- **`setup()`**: 初期化処理
- **`loop()`**: メインループ（シリアル入力監視）

## トラブルシューティング

### カメラが初期化できない

**症状**: "カメラの初期化に失敗しました" というエラーメッセージ

**対処法**:
- カメラボードがメインボードにしっかり接続されているか確認
- カメラモジュールのケーブル接続を確認
- 電源供給が十分か確認（外部電源使用を推奨）

### SDカードエラー

**症状**: "SDカードの初期化に失敗しました"

**対処法**:
- SDカードが正しく挿入されているか確認
- SDカードがフォーマットされているか確認（FAT32推奨）
- 別のSDカードで試す
- SDカードの接触不良を確認

### 画面に何も表示されない

**症状**: ディスプレイが真っ暗または変な表示

**対処法**:
- ディスプレイのピン接続を再確認（特にD13, D11, D9, D10, D8）
- 電源電圧を確認（3.3V）
- シリアルモニタで "ストリーミング開始しました" が表示されているか確認
- display_testプロジェクトで単独でディスプレイが動作するか確認

### 撮影はできるが表示がおかしい

**症状**: JPEGは保存されるがライブビューの色がおかしい

**対処法**:
- `setSwapBytes(true)`が正しく設定されているか確認
- カメラのピクセルフォーマット変換が正常に動作しているか確認

### フレームレートが低い

**症状**: 映像がカクカクする、遅延が大きい

**対処法**:
- **SPI通信速度を調整**: `LGFX_SPRESENSE_ILI9341.hpp`の`freq_write`を変更
  ```cpp
  cfg.freq_write = 20000000;  // 40MHz → 20MHzに下げる
  ```
- 外部電源を使用（USB給電では電力不足の可能性）

### 撮影失敗

**症状**: "撮影に失敗しました" エラー

**対処法**:
- カメラが正常に動作しているか確認
- ストリーミング停止時間を延長（`delay(100)`を`delay(200)`に変更）
- 電源供給が安定しているか確認

### 電源の問題

**症状**: 動作が不安定、リセットがかかる

**対処法**:
- **外部電源を使用**（5V 2A以上推奨）
- USB給電の場合は高出力のUSB電源アダプタを使用
- カメラとディスプレイの同時使用は電力消費が大きいため、安定した電源が必須

## カスタマイズ

### 画面の向きを変更

`src/main.cpp`の`setupDisplay()`関数内：
```cpp
lcd.setRotation(0);  // 0, 1, 2, 3 で90度ごとに回転
```

### 撮影解像度の変更

`src/main.cpp`の`setupCamera()`関数内：
```cpp
// HDから他の解像度に変更
err = theCamera.setStillPictureImageFormat(
  CAM_IMGSIZE_QVGA_H,    // 横320（より低解像度）
  CAM_IMGSIZE_QVGA_V,    // 縦240
  CAM_IMAGE_PIX_FMT_JPG
);

// またはより高解像度に
err = theCamera.setStillPictureImageFormat(
  CAM_IMGSIZE_FULLHD_H,  // 横1920（フルHD）
  CAM_IMGSIZE_FULLHD_V,  // 縦1080
  CAM_IMAGE_PIX_FMT_JPG
);
```

### HDRモードの変更

```cpp
// HDRを常にON
err = theCamera.setHDR(CAM_HDR_MODE_ON);

// HDRをOFF
err = theCamera.setHDR(CAM_HDR_MODE_OFF);

// HDR自動（デフォルト）
err = theCamera.setHDR(CAM_HDR_MODE_AUTO);
```

### ファイル名の変更

`src/main.cpp`の`takePictureAndSave()`関数内：
```cpp
// ファイル名を変更
sprintf(filename, "IMG_%04d.JPG", pictureCount);  // IMG_0000.JPG形式
sprintf(filename, "PHOTO%03d.JPG", pictureCount); // PHOTO000.JPG形式
```

### SPI通信速度の調整

`src/LGFX_SPRESENSE_ILI9341.hpp`で通信速度を変更：
```cpp
cfg.freq_write = 40000000;  // 40MHz（デフォルト）
cfg.freq_write = 20000000;  // 20MHz（安定重視）
cfg.freq_write = 60000000;  // 60MHz（高速、不安定の可能性）
```

## 技術詳細

### アーキテクチャ

1. **ライブビュー**:
   - `startStreaming()`でコールバック方式を使用
   - カメラからYUV422形式で取得
   - コールバック内でRGB565に変換
   - `setSwapBytes(true)`でバイトオーダー調整
   - LovyanGFXで高速転送

2. **JPEG撮影**:
   - シリアル入力検出
   - ストリーミング一時停止
   - カメラハードウェアでJPEGエンコード
   - SDカードに保存
   - ストリーミング再開

3. **メモリ管理**:
   - ライブビュー: QVGA RGB565バッファ
   - JPEG撮影: HD JPEGバッファ（別領域）
   - 自動メモリ管理

### メモリ使用量

- ライブビューバッファ: 約150KB（QVGA RGB565）
- JPEG撮影バッファ: カメラハードウェア管理
- 合計: 約200-300KB

### 消費電力

- カメラ動作時: 約200-300mA
- ディスプレイ動作時: 約50-100mA（輝度による）
- JPEG撮影時: 約350-450mA（ピーク時）
- 合計平均: **約300-400mA**（外部電源推奨）

## 制限事項

1. **同時撮影不可**: ライブビュー表示中は撮影が一時停止します
2. **ファイル名**: 電源OFF時にカウンタはリセットされます（上書き注意）
3. **SDカード容量**: 空き容量が不足すると保存できません
4. **電源要件**: 安定した電源供給が必要（外部電源推奨）

## 次のステップ

このプロジェクトで基本的なカメラアプリケーションが動作することを確認したら、以下の機能を追加できます：

1. **ボタン撮影**: 外部ボタンで撮影トリガー
2. **タイムスタンプ**: ファイル名に日時を追加
3. **画像フィルタリング**: エッジ検出、コントラスト調整
4. **オーバーレイ表示**: フレームレート、撮影枚数の表示
5. **連写機能**: 連続撮影モード
6. **シュリーレン画像処理**: 密度変化の可視化（本プロジェクトの最終目標）

## 参考資料

- [LovyanGFX GitHub](https://github.com/lovyan03/LovyanGFX)
- [SPRESENSE Camera API](https://developer.sony.com/develop/spresense/docs/arduino_developer_guide_ja.html#_camera)
- [SPRESENSE公式ドキュメント](https://developer.sony.com/develop/spresense/)
- [ILI9341データシート](https://cdn-shop.adafruit.com/datasheets/ILI9341.pdf)

## ライセンス

TBD

---

**更新日**: 2025/12/02  
**プロジェクト状況**: 完成 - ライブビュー表示 + JPEG撮影・保存機能の実装完了、動作確認済み

# Schlieren Camera - シュリーレン撮影プロジェクト

SPRESENSEカメラを使用したシュリーレン撮影システムのプロジェクトです。

## 概要

このプロジェクトは、SPRESENSEのHDRカメラとシュリーレン光学系を組み合わせて、空気の密度変化を可視化するシュリーレン撮影システムです。display_streamingプロジェクトをベースに、シュリーレン撮影に最適化された機能を追加していく予定です。

シュリーレン法は、透明な媒質（空気、水など）の密度変化を可視化する光学的手法で、熱対流、衝撃波、音波などの観察に使用されます。

## 主な機能（計画中）

- **ライブビュー**: QVGA（320x240）解像度でのリアルタイム映像表示
- **高速撮影**: シュリーレン現象の瞬間を捉える高速撮影
- **トリガー撮影**: 外部信号による同期撮影
- **連続撮影**: 時系列での密度変化記録
- **画像処理**: コントラスト強調、エッジ検出などのリアルタイム処理
- **HDR撮影**: 明暗差の大きいシーンでの最適化
- **microSD保存**: 高解像度JPEG画像の保存

## シュリーレン法について

### 原理
シュリーレン法は、屈折率の変化（密度変化）を光の偏向として検出し、可視化する手法です。

1. 平行光を被写体に照射
2. 密度変化により光が屈折
3. ナイフエッジで偏向した光を遮断
4. 明暗のコントラストとして可視化

### 応用例
- **熱流解析**: ヒーター、ろうそくの熱対流
- **空力解析**: 翼周りの気流、衝撃波
- **音響可視化**: スピーカーからの音波
- **燃焼解析**: 炎の構造、燃焼ガスの流れ

## ハードウェア構成

### 必要な機器

#### 電子機器
- **SPRESENSE メインボード**
- **SPRESENSE 拡張ボード**
- **SPRESENSE HDRカメラボード**
- **ILI9341ドライバ搭載 TFT液晶**（240x320ピクセル、SPI接続）
- **microSDカード**（画像保存用、Class 10推奨）

#### シュリーレン光学系
- **点光源**: LED（高輝度白色LED推奨）
- **凸レンズ**: 2枚（直径50-100mm、焦点距離200-500mm）
- **ナイフエッジ**: かみそりの刃、精密スリットなど
- **光学台**: レンズやカメラを固定するための台
- **遮光板**: 外乱光を遮断

### 光学系配置

```
[LED] → [レンズ1] → [被写体] → [レンズ2] → [ナイフエッジ] → [カメラ]
 光源     コリメート              集光        空間フィルタ    撮像
```

1. **光源部**: LEDをレンズ1の焦点に配置
2. **平行光**: レンズ1で平行光を生成
3. **被写体空間**: 平行光が通過する領域
4. **結像部**: レンズ2で光を集光
5. **ナイフエッジ**: レンズ2の焦点に配置（光源像を半分遮る）
6. **カメラ**: ナイフエッジの後方に配置

### ピン配置

#### カメラ接続
カメラボードはSPRESENSEメインボードに直接接続します。

#### ディスプレイ接続（SPI4使用）

| 機能 | SPRESENSEピン | 説明 |
|------|--------------|------|
| **SCLK** | D13 (SPI4) | SPIクロック |
| **MOSI** | D11 (SPI4) | SPIデータ出力 |
| **MISO** | D12 (SPI4) | SPIデータ入力 |
| **DC** | D9 | データ/コマンド選択 |
| **CS** | D10 | チップセレクト |
| **RESET** | D8 | リセット |
| **VCC** | 3.3V | 電源 |
| **GND** | GND | グランド |

#### 外部トリガー（計画中）
| 機能 | SPRESENSEピン | 説明 |
|------|--------------|------|
| **TRIGGER** | D2 | 外部トリガー入力（割り込み対応） |

**重要**: 
- 外部電源の使用を推奨（5V 2A以上）
- シュリーレン撮影は遮光が重要です
- カメラのISO感度とシャッター速度の調整が必要です

## 開発環境

### 必要なソフトウェア

- [PlatformIO](https://platformio.org/)
- Visual Studio Code + PlatformIO IDE拡張機能

### 使用ライブラリ

- **LovyanGFX** (v1.1.16以降): 高速グラフィックスライブラリ
- **Camera**: SPRESENSE標準カメラライブラリ
- **SDHCI**: SPRESENSE標準SDカードライブラリ

## セットアップ手順

### 1. 光学系の組み立て

1. **光学台の準備**: 各光学素子を配置できる台を用意
2. **レンズ配置**: 2枚のレンズを被写体を挟んで配置（焦点距離の2倍程度離す）
3. **光源設置**: LED光源をレンズ1の焦点に配置
4. **ナイフエッジ調整**: レンズ2の焦点位置に配置し、光源像の半分を遮る
5. **カメラ設置**: ナイフエッジの後方に配置
6. **遮光**: 外乱光を遮断

### 2. ハードウェア接続

1. HDRカメラボードをSPRESENSEメインボードに接続
2. TFT液晶を拡張ボードに接続
3. microSDカードを拡張ボードのスロットに挿入
4. 外部電源を接続（推奨：5V 2A以上）

### 3. プロジェクトのビルドとアップロード

#### Visual Studio Codeでの操作

**重要**: このリポジトリには複数のPlatformIOプロジェクトが含まれています。**schlieren_cameraフォルダを直接開いてください**。

1. VS Codeで**schlieren_cameraフォルダ**を開きます
   - `ファイル` → `フォルダーを開く` → `schlieren_camera`フォルダを選択

2. PlatformIOタブを開きます

3. ビルド: `Ctrl+Alt+B`

4. アップロード: `Ctrl+Alt+U`

5. シリアルモニタ: `Ctrl+Alt+S`

#### コマンドラインでの操作

```bash
cd schlieren_camera
pio run
pio run --target upload
pio device monitor
```

## 使用方法

### 光学系の調整

1. **アライメント確認**: カメラ画面に光が均一に入っているか確認
2. **ナイフエッジ調整**: 画面の明るさが全体的に少し暗くなる位置に調整
3. **感度テスト**: 手を被写体空間に入れて、輪郭が見えるか確認
4. **微調整**: ナイフエッジの位置と角度を微調整してコントラストを最大化

### 撮影（現在はdisplay_streamingと同じ動作）

1. ライブビューで被写体を確認
2. シリアルモニタから任意の文字を送信して撮影
3. HD画質（1280x720）のJPEG画像がSDカードに保存されます

### 撮影のコツ

1. **遮光**: 外乱光を完全に遮断
2. **振動対策**: カメラや光学系が振動しないように固定
3. **ISO調整**: 明るさに応じてISO感度を調整
4. **シャッター速度**: 現象の速さに応じて調整
5. **ナイフエッジ方向**: 観察したい密度変化の方向に対して垂直に配置

## プロジェクト構成

```
schlieren_camera/
├── platformio.ini                    # PlatformIO設定ファイル
├── README.md                         # 本ファイル
├── .gitignore                        # Git除外設定
├── include/                          # ヘッダファイル用ディレクトリ
├── lib/                              # 追加ライブラリ用ディレクトリ
└── src/
    ├── main.cpp                      # メインプログラム
    └── LGFX_SPRESENSE_ILI9341.hpp   # LovyanGFX設定ファイル
```

## トラブルシューティング

### シュリーレン像が見えない

**対処法**:
- ナイフエッジの位置を再調整（焦点位置に正確に配置）
- ナイフエッジの遮光量を調整（半分程度）
- 外乱光を完全に遮断
- レンズの焦点距離と配置を確認

### コントラストが低い

**対処法**:
- ナイフエッジの位置を微調整
- 光源の明るさを上げる
- カメラのISO感度を調整
- レンズの開口を調整

### 画像が暗すぎる／明るすぎる

**対処法**:
- ナイフエッジの遮光量を調整
- カメラの露出設定を調整
- 光源の明るさを調整

### 電子機器関連

カメラ、SDカード、ディスプレイのトラブルは、display_streamingプロジェクトのREADMEを参照してください。

## 今後の開発計画

### Phase 1: 基本機能の実装
- [x] display_streamingコードのベース構築
- [ ] シュリーレン撮影に最適化されたカメラ設定
- [ ] マニュアル露出・ISO設定機能

### Phase 2: 高速撮影
- [ ] 外部トリガー入力機能
- [ ] 高速連続撮影モード
- [ ] バッファリング機能

### Phase 3: 画像処理
- [ ] リアルタイムコントラスト強調
- [ ] エッジ検出フィルタ
- [ ] 背景差分処理

### Phase 4: 解析機能
- [ ] 密度変化の定量化
- [ ] 時系列データの記録
- [ ] PC連携による詳細解析

## 技術仕様（目標）

### 撮影性能
- **解像度**: HD (1280x720) ～ Full HD (1920x1080)
- **フレームレート**: 5-30 FPS（連続撮影時）
- **シャッター速度**: 1/30 ～ 1/10000秒（調整可能）
- **ISO感度**: 100-1600（調整可能）

### 光学系要件
- **レンズ焦点距離**: 200-500mm推奨
- **光源**: 高輝度白色LED（ハロゲンランプも可）
- **ナイフエッジ**: かみそりの刃、精密スリット

## シュリーレン撮影の例

### 観察できる現象

1. **熱対流**
   - ろうそくの炎
   - ヒーターからの熱気
   - 手の周りの暖かい空気

2. **音波**
   - スピーカーからの音
   - 手を叩いた時の衝撃波
   - 笛の音

3. **流体の動き**
   - ドライヤーからの風
   - 扇風機の気流
   - 物体を落下させた時の空気の動き

4. **燃焼**
   - ガスバーナーの炎
   - マッチの燃焼
   - アルコールランプの炎

## 参考資料

### シュリーレン法
- [NASA Schlieren Photography](https://www.grc.nasa.gov/www/k-12/airplane/tunvschlrn.html)
- [Schlieren and Shadowgraph Techniques (Springer)](https://link.springer.com/book/10.1007/978-3-642-56640-0)

### SPRESENSE
- [LovyanGFX GitHub](https://github.com/lovyan03/LovyanGFX)
- [SPRESENSE Camera API](https://developer.sony.com/develop/spresense/docs/arduino_developer_guide_ja.html#_camera)
- [SPRESENSE公式ドキュメント](https://developer.sony.com/develop/spresense/)

## ライセンス

TBD

---

**更新日**: 2025/12/03  
**プロジェクト状況**: 開発準備中 - display_streamingコードをベースにセットアップ完了。シュリーレン撮影専用機能は今後実装予定。
